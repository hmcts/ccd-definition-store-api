<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="rdm-2917" author="fatih.ozceylan@hmcts.net">

        <renameTable newTableName="role" oldTableName="case_role" schemaName="public"/>

        <!-- role table changes-->
        <!-- Change precision of reference, name and description columns in role table -->
        <modifyDataType columnName="reference" newDataType="varchar(255)" tableName="role"/>
        <modifyDataType columnName="name" newDataType="varchar(255)" tableName="role"/>
        <modifyDataType columnName="description" newDataType="varchar(255)" tableName="role"/>

        <!-- Add new security_classification and user_role_id fields to the role table -->
        <addColumn tableName="role">
            <column name="user_role_id" type="integer" >
                <constraints nullable="true"/>
            </column>
            <column name="security_classification" type="security_classification" >
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <!-- Update existing role data with PUBLIC security_classification -->
        <sql>
            update case_role set security_classification = 'PUBLIC' where security_classification isnull;
        </sql>

        <!-- Add not null constraint for secutiry_classification column in role table-->
        <addNotNullConstraint columnDataType="security_classification"
                              columnName="security_classification"
                              defaultNullValue="PUBLIC"
                              tableName="role"/>

        <!-- case_field_user_role table changes -->
        <!-- Add new role_id column to the case_field_user_role table -->
        <addColumn tableName="case_field_user_role">
            <column name="role_id" type="integer" >
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <!-- Add foreign key for role_id column linking to role table -->
        <addForeignKeyConstraint baseColumnNames="role_id"
                                 baseTableName="case_field_user_role"
                                 constraintName="fk_case_field_user_role_role_id"
                                 referencedColumnNames="id"
                                 referencedTableName="role"/>

        <!-- Add unique constraint on case_field_id and role_id columns for the case_field_user_role table -->
        <addUniqueConstraint columnNames="case_field_id, role_id"
                             constraintName="unique_case_field_user_role_case_field_id_role_id"
                             tableName="case_field_user_role"/>


        <!-- case_type_user_role table changes -->
        <!-- Add new role_id column to the case_type_user_role table -->
        <addColumn tableName="case_type_user_role">
            <column name="role_id" type="integer" >
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <!-- Add foreign key for role_id column linking to role table -->
        <addForeignKeyConstraint baseColumnNames="role_id"
                                 baseTableName="case_type_user_role"
                                 constraintName="fk_case_type_user_role_role_id"
                                 referencedColumnNames="id"
                                 referencedTableName="role"/>

        <!-- Add unique constraint on case_type_id and role_id columns for the case_type_user_role table -->
        <addUniqueConstraint columnNames="case_type_id, role_id"
                             constraintName="unique_case_type_user_role_case_type_id_role_id"
                             tableName="case_type_user_role"/>


        <!-- event_user_role table changes -->
        <!-- Add new role_id column to the event_user_role table -->
        <addColumn tableName="event_user_role">
            <column name="role_id" type="integer" >
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <!-- Add foreign key for role_id column linking to role table -->
        <addForeignKeyConstraint baseColumnNames="role_id"
                                 baseTableName="event_user_role"
                                 constraintName="fk_event_user_role_role_id"
                                 referencedColumnNames="id"
                                 referencedTableName="role"/>

        <!-- Add unique constraint on event_id and role_id columns for the event_user_role table -->
        <addUniqueConstraint columnNames="event_id, role_id"
                             constraintName="unique_event_user_role_event_id_role_id"
                             tableName="event_user_role"/>


        <!-- state_user_role table changes -->
        <!-- Add new role_id column to the state_user_role table -->
        <addColumn tableName="state_user_role">
            <column name="role_id" type="integer" >
                <constraints nullable="true"/>
            </column>
        </addColumn>

        <!-- Add foreign key for role_id column linking to role table -->
        <addForeignKeyConstraint baseColumnNames="role_id"
                                 baseTableName="state_user_role"
                                 constraintName="fk_state_user_role_role_id"
                                 referencedColumnNames="id"
                                 referencedTableName="role"/>

        <!-- Add unique constraint on state_id and role_id columns for the state_user_role table -->
        <addUniqueConstraint columnNames="state_id, role_id"
                             constraintName="unique_state_user_role_state_id_role_id"
                             tableName="state_user_role"/>


        <!-- MIGRATE the DATA -->
        <!-- Pull in the user_roles into role table -->
        <sql>
            INSERT INTO role (user_role_id, reference, name, description, security_classification)
            SELECT id as user_role_id, "role" AS reference, "role" AS name, "role" AS description, security_classification FROM user_role;
        </sql>
        <!-- Pull in the role_id into case_field_user_role table -->
        <sql>
            Update case_field_user_role cfur
            set role_id = (SELECT cr.id id FROM role cr where cr.user_role_id = cfur.user_role_id )
            WHERE exists (SELECT 1  from role cr where cr.user_role_id = cfur.user_role_id);
        </sql>
        <!-- Pull in the role_id into case_type_user_role table -->
        <sql>
            Update case_type_user_role ctur
            set role_id = (SELECT cr.id id FROM role cr where cr.user_role_id = ctur.user_role_id )
            WHERE exists (SELECT 1  from role cr where cr.user_role_id = ctur.user_role_id);
        </sql>
        <!-- Pull in the role_id into event_user_role table -->
        <sql>
            Update event_user_role eur
            set role_id = (SELECT cr.id id FROM role cr where cr.user_role_id = eur.user_role_id )
            WHERE exists (SELECT 1  from role cr where cr.user_role_id = eur.user_role_id);
        </sql>
        <!-- Pull in the role_id into state_user_role table -->
        <sql>
            Update state_user_role sur
            set role_id = (SELECT cr.id id FROM role cr where cr.user_role_id = sur.user_role_id )
            WHERE exists (SELECT 1  from role cr where cr.user_role_id = sur.user_role_id);
        </sql>
    </changeSet>
</databaseChangeLog>
