<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="rdm-9555" author="kiran.yenigala@hmcts.net">

        <createTable tableName="event_post_state">
            <column name="id" type="serial">
                <constraints nullable="false"/>
            </column>
            <column name="enabling_condition" type="varchar(2000)">
                <constraints nullable="true"/>
            </column>
            <column name="priority" type="integer">
                <constraints nullable="true"/>
            </column>
            <column name="case_event_id" type="integer">
                <constraints nullable="false"/>
            </column>
            <column name="post_state_reference"  type="varchar(70)" >
                <constraints nullable="true" />
            </column>
        </createTable>

        <addForeignKeyConstraint baseColumnNames="case_event_id"
                                 baseTableName="event_post_state"
                                 constraintName="fk_event_post_state_case_event_id"
                                 referencedColumnNames="id"
                                 referencedTableName="event"/>

        <addUniqueConstraint columnNames="case_event_id, post_state_reference"
                             constraintName="unique_case_event_id_post_state_reference"
                             tableName="event_post_state"/>

        <!-- copy table column post_state_id data to the new event_post_state table -->
        <sql>
            insert into event_post_state (case_event_id, post_state_reference)
            select e.id, s.reference from event e, state s where s.id = e.post_state_id;
        </sql>

        <!--Drop post_state_id column from event_post_state column-->
        <dropColumn tableName="event" columnName="post_state_id"></dropColumn>

        <rollback>
            <addColumn tableName="event">
                <column name="post_state_id" type="integer">
                    <constraints nullable="true"/>
                </column>
            </addColumn>
        </rollback>

        <rollback>
            insert into event (post_state_id) ce
            select id from state where reference = (select post_state_reference from event_post_state eps where eps.case_event_id = ce.id);
        </rollback>

        <rollback>
            <dropTable tableName="event_post_state"/>
        </rollback>
    </changeSet>
</databaseChangeLog>
